<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent ç®¡ç†é¢æ¿ - Spring AI Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: #f8f9fa;
            transition: background-color 0.3s;
        }
        .tab.active {
            background: #007bff;
            color: white;
        }
        .tab:hover {
            background: #e9ecef;
        }
        .tab.active:hover {
            background: #0056b3;
        }
        .content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .results {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        .file-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-info {
            flex: 1;
        }
        .file-name {
            font-weight: bold;
            color: #333;
        }
        .file-path {
            font-size: 12px;
            color: #666;
        }
        .file-size {
            font-size: 12px;
            color: #999;
        }
        .download-task {
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #f8f9fa;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .hidden {
            display: none;
        }
        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– Agent ç®¡ç†é¢æ¿</h1>
            <p>æ–‡ä»¶æœç´¢ã€ä¸‹è½½ç®¡ç†å’Œç³»ç»Ÿç›‘æ§</p>
        </div>

        <div id="status" class="status disconnected">
            æ­£åœ¨æ£€æŸ¥è¿æ¥çŠ¶æ€...
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('search')">ğŸ” æ–‡ä»¶æœç´¢</button>
            <button class="tab" onclick="showTab('download')">â¬‡ï¸ ä¸‹è½½ç®¡ç†</button>
            <button class="tab" onclick="showTab('system')">ğŸ“Š ç³»ç»Ÿä¿¡æ¯</button>
        </div>

        <!-- æ–‡ä»¶æœç´¢æ ‡ç­¾é¡µ -->
        <div id="search-tab" class="content">
            <h2>æ–‡ä»¶æœç´¢</h2>
            
            <div class="form-group">
                <label for="searchQuery">æœç´¢å…³é”®è¯ï¼š</label>
                <input type="text" id="searchQuery" placeholder="è¾“å…¥æ–‡ä»¶åæˆ–å†…å®¹å…³é”®è¯">
            </div>
            
            <div class="form-group">
                <label for="searchPath">æœç´¢è·¯å¾„ï¼š</label>
                <input type="text" id="searchPath" placeholder="é»˜è®¤ä¸ºå½“å‰ç›®å½•" value=".">
            </div>
            
            <div class="form-group">
                <label>æœç´¢ç±»å‹ï¼š</label>
                <select id="searchType">
                    <option value="files">æ–‡ä»¶åæœç´¢</option>
                    <option value="content">å†…å®¹æœç´¢</option>
                    <option value="both">å…¨éƒ¨æœç´¢</option>
                </select>
            </div>
            
            <button onclick="performSearch()">ğŸ” å¼€å§‹æœç´¢</button>
            
            <div id="searchResults" class="results hidden">
                <h3>æœç´¢ç»“æœ</h3>
                <div id="searchResultsContent"></div>
            </div>
        </div>

        <!-- ä¸‹è½½ç®¡ç†æ ‡ç­¾é¡µ -->
        <div id="download-tab" class="content hidden">
            <h2>ä¸‹è½½ç®¡ç†</h2>
            
            <div class="form-group">
                <label for="downloadUrl">ä¸‹è½½URLï¼š</label>
                <input type="url" id="downloadUrl" placeholder="https://example.com/file.txt">
            </div>
            
            <div class="form-group">
                <label for="downloadPath">ä¿å­˜è·¯å¾„ï¼š</label>
                <input type="text" id="downloadPath" placeholder="é»˜è®¤ä¸º ./downloads" value="./downloads">
            </div>
            
            <button onclick="startDownload()">â¬‡ï¸ å¼€å§‹ä¸‹è½½</button>
            
            <div id="downloadTasks" class="results">
                <h3>ä¸‹è½½ä»»åŠ¡</h3>
                <div id="downloadTasksContent"></div>
            </div>
        </div>

        <!-- ç³»ç»Ÿä¿¡æ¯æ ‡ç­¾é¡µ -->
        <div id="system-tab" class="content hidden">
            <h2>ç³»ç»Ÿä¿¡æ¯</h2>
            
            <button onclick="refreshSystemInfo()">ğŸ”„ åˆ·æ–°ä¿¡æ¯</button>
            
            <div id="systemInfo" class="results">
                <h3>ç³»ç»ŸçŠ¶æ€</h3>
                <div id="systemInfoContent"></div>
            </div>
        </div>
    </div>

    <script>
        let isConnected = false;

        // æ£€æŸ¥è¿æ¥çŠ¶æ€
        async function checkConnection() {
            try {
                const response = await fetch('/api/chat/health');
                if (response.ok) {
                    isConnected = true;
                    document.getElementById('status').className = 'status connected';
                    document.getElementById('status').textContent = 'âœ… å·²è¿æ¥åˆ°æœåŠ¡';
                } else {
                    throw new Error('Health check failed');
                }
            } catch (error) {
                isConnected = false;
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'âŒ æ— æ³•è¿æ¥åˆ°æœåŠ¡';
            }
        }

        // æ˜¾ç¤ºæ ‡ç­¾é¡µ
        function showTab(tabName) {
            // éšè—æ‰€æœ‰å†…å®¹
            document.querySelectorAll('.content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨æ ‡ç­¾
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            event.target.classList.add('active');
            
            // å¦‚æœæ˜¯ç³»ç»Ÿæ ‡ç­¾é¡µï¼Œè‡ªåŠ¨åˆ·æ–°ä¿¡æ¯
            if (tabName === 'system') {
                refreshSystemInfo();
            }
        }

        // æ‰§è¡Œæœç´¢
        async function performSearch() {
            if (!isConnected) {
                alert('è¯·å…ˆç¡®ä¿æœåŠ¡æ­£åœ¨è¿è¡Œ');
                return;
            }

            const query = document.getElementById('searchQuery').value.trim();
            const path = document.getElementById('searchPath').value.trim() || '.';
            const type = document.getElementById('searchType').value;

            if (!query) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            try {
                let results = [];
                
                if (type === 'files' || type === 'both') {
                    const filesResponse = await fetch(`/api/agent/search/files?query=${encodeURIComponent(query)}&basePath=${encodeURIComponent(path)}`);
                    if (filesResponse.ok) {
                        const files = await filesResponse.json();
                        results.push(...files);
                    }
                }
                
                if (type === 'content' || type === 'both') {
                    const contentResponse = await fetch(`/api/agent/search/content?query=${encodeURIComponent(query)}&basePath=${encodeURIComponent(path)}`);
                    if (contentResponse.ok) {
                        const contentMatches = await contentResponse.json();
                        results.push(...contentMatches);
                    }
                }

                displaySearchResults(results, type);
            } catch (error) {
                showError('æœç´¢å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ˜¾ç¤ºæœç´¢ç»“æœ
        function displaySearchResults(results, type) {
            const container = document.getElementById('searchResults');
            const content = document.getElementById('searchResultsContent');
            
            if (results.length === 0) {
                content.innerHTML = '<p>æœªæ‰¾åˆ°åŒ¹é…çš„ç»“æœ</p>';
            } else {
                let html = `<p>æ‰¾åˆ° ${results.length} ä¸ªç»“æœï¼š</p>`;
                
                results.forEach((item, index) => {
                    if (item.path) {
                        // æ–‡ä»¶æœç´¢ç»“æœ
                        html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <div class="file-name">${item.name}</div>
                                    <div class="file-path">${item.path}</div>
                                    <div class="file-size">${formatFileSize(item.size)}</div>
                                </div>
                                <div>
                                    <button onclick="readFile('${item.path}')">ğŸ“– è¯»å–</button>
                                    <button onclick="downloadLocalFile('${item.path}')" style="margin-left: 5px;">â¬‡ï¸ ä¸‹è½½</button>
                                </div>
                            </div>
                        `;
                    } else if (item.filePath) {
                        // å†…å®¹æœç´¢ç»“æœ
                        html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <div class="file-name">å†…å®¹åŒ¹é…</div>
                                    <div class="file-path">${item.filePath}</div>
                                    <div class="file-size">${item.matches.length} å¤„åŒ¹é…</div>
                                </div>
                                <div>
                                    <button onclick="readFile('${item.filePath}')">ğŸ“– è¯»å–</button>
                                    <button onclick="downloadLocalFile('${item.filePath}')" style="margin-left: 5px;">â¬‡ï¸ ä¸‹è½½</button>
                                </div>
                            </div>
                        `;
                    }
                });
                
                content.innerHTML = html;
            }
            
            container.classList.remove('hidden');
        }

        // è¯»å–æ–‡ä»¶
        async function readFile(filePath) {
            try {
                const response = await fetch(`/api/agent/files/content?filePath=${encodeURIComponent(filePath)}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        alert(`æ–‡ä»¶å†…å®¹é¢„è§ˆï¼š\n\n${data.content.substring(0, 500)}${data.content.length > 500 ? '...' : ''}`);
                    } else {
                        alert('æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹');
                    }
                }
            } catch (error) {
                alert('è¯»å–æ–‡ä»¶å¤±è´¥ï¼š' + error.message);
            }
        }

        // ä¸‹è½½æœ¬åœ°æ–‡ä»¶
        async function downloadLocalFile(filePath) {
            if (!isConnected) {
                alert('è¯·å…ˆç¡®ä¿æœåŠ¡æ­£åœ¨è¿è¡Œ');
                return;
            }

            const targetPath = prompt('è¯·è¾“å…¥ç›®æ ‡ç›®å½•ï¼ˆé»˜è®¤ä¸º ./downloadsï¼‰ï¼š', './downloads');
            if (targetPath === null) return; // ç”¨æˆ·å–æ¶ˆ

            try {
                const response = await fetch('/api/agent/download/local', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        filePath: filePath, 
                        targetDirectory: targetPath || './downloads' 
                    })
                });

                if (response.ok) {
                    const task = await response.json();
                    showSuccess(`ä¸‹è½½ä»»åŠ¡å·²åˆ›å»ºï¼Œä»»åŠ¡IDï¼š${task.taskId}`);
                    refreshDownloadTasks();
                } else {
                    showError('åˆ›å»ºä¸‹è½½ä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                showError('ä¸‹è½½å¤±è´¥ï¼š' + error.message);
            }
        }

        // å¼€å§‹ä¸‹è½½
        async function startDownload() {
            if (!isConnected) {
                alert('è¯·å…ˆç¡®ä¿æœåŠ¡æ­£åœ¨è¿è¡Œ');
                return;
            }

            const url = document.getElementById('downloadUrl').value.trim();
            const path = document.getElementById('downloadPath').value.trim() || './downloads';

            if (!url) {
                alert('è¯·è¾“å…¥ä¸‹è½½URL');
                return;
            }

            try {
                const response = await fetch('/api/agent/download/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url: url, targetDirectory: path })
                });

                if (response.ok) {
                    const task = await response.json();
                    showSuccess(`ä¸‹è½½ä»»åŠ¡å·²åˆ›å»ºï¼Œä»»åŠ¡IDï¼š${task.taskId}`);
                    refreshDownloadTasks();
                } else {
                    showError('åˆ›å»ºä¸‹è½½ä»»åŠ¡å¤±è´¥');
                }
            } catch (error) {
                showError('ä¸‹è½½å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ·æ–°ä¸‹è½½ä»»åŠ¡
        async function refreshDownloadTasks() {
            try {
                const response = await fetch('/api/agent/download/tasks');
                if (response.ok) {
                    const tasks = await response.json();
                    displayDownloadTasks(tasks);
                }
            } catch (error) {
                console.error('è·å–ä¸‹è½½ä»»åŠ¡å¤±è´¥ï¼š', error);
            }
        }

        // æ˜¾ç¤ºä¸‹è½½ä»»åŠ¡
        function displayDownloadTasks(tasks) {
            const content = document.getElementById('downloadTasksContent');
            
            if (tasks.length === 0) {
                content.innerHTML = '<p>æš‚æ— ä¸‹è½½ä»»åŠ¡</p>';
                return;
            }

            let html = '';
            tasks.forEach(task => {
                const progress = task.progress || 0;
                const statusText = getStatusText(task.status);
                
                html += `
                    <div class="download-task">
                        <div><strong>ä»»åŠ¡IDï¼š</strong>${task.taskId}</div>
                        <div><strong>URLï¼š</strong>${task.url}</div>
                        <div><strong>çŠ¶æ€ï¼š</strong>${statusText}</div>
                        <div><strong>è¿›åº¦ï¼š</strong>${progress.toFixed(1)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div><strong>å·²ä¸‹è½½ï¼š</strong>${formatFileSize(task.downloadedSize)} / ${formatFileSize(task.totalSize)}</div>
                        ${task.localPath ? `<div><strong>æœ¬åœ°è·¯å¾„ï¼š</strong>${task.localPath}</div>` : ''}
                        ${task.errorMessage ? `<div class="error">é”™è¯¯ï¼š${task.errorMessage}</div>` : ''}
                        <div style="margin-top: 10px;">
                            <button onclick="cancelDownload('${task.taskId}')" ${task.status !== 'DOWNLOADING' ? 'disabled' : ''}>å–æ¶ˆ</button>
                            <button onclick="deleteDownloadTask('${task.taskId}')">åˆ é™¤</button>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }

        // å–æ¶ˆä¸‹è½½
        async function cancelDownload(taskId) {
            try {
                const response = await fetch(`/api/agent/download/cancel/${taskId}`, { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showSuccess('ä¸‹è½½å·²å–æ¶ˆ');
                        refreshDownloadTasks();
                    } else {
                        showError('å–æ¶ˆä¸‹è½½å¤±è´¥');
                    }
                }
            } catch (error) {
                showError('å–æ¶ˆä¸‹è½½å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ é™¤ä¸‹è½½ä»»åŠ¡
        async function deleteDownloadTask(taskId) {
            try {
                const response = await fetch(`/api/agent/download/task/${taskId}`, { method: 'DELETE' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showSuccess('ä»»åŠ¡å·²åˆ é™¤');
                        refreshDownloadTasks();
                    } else {
                        showError('åˆ é™¤ä»»åŠ¡å¤±è´¥');
                    }
                }
            } catch (error) {
                showError('åˆ é™¤ä»»åŠ¡å¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ·æ–°ç³»ç»Ÿä¿¡æ¯
        async function refreshSystemInfo() {
            try {
                const response = await fetch('/api/agent/system/info');
                if (response.ok) {
                    const info = await response.json();
                    displaySystemInfo(info);
                }
            } catch (error) {
                showError('è·å–ç³»ç»Ÿä¿¡æ¯å¤±è´¥ï¼š' + error.message);
            }
        }

        // æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
        function displaySystemInfo(info) {
            const content = document.getElementById('systemInfoContent');
            
            const html = `
                <div>
                    <h4>å†…å­˜ä½¿ç”¨æƒ…å†µ</h4>
                    <p><strong>æ€»å†…å­˜ï¼š</strong>${info.memory.total}</p>
                    <p><strong>å·²ä½¿ç”¨ï¼š</strong>${info.memory.used}</p>
                    <p><strong>å¯ç”¨å†…å­˜ï¼š</strong>${info.memory.free}</p>
                    <p><strong>ä½¿ç”¨ç‡ï¼š</strong>${info.memory.usagePercent}</p>
                </div>
                <div style="margin-top: 20px;">
                    <h4>ä¸‹è½½ä»»åŠ¡çŠ¶æ€</h4>
                    <p><strong>æ´»è·ƒä»»åŠ¡ï¼š</strong>${info.downloads.activeTasks}</p>
                    <p><strong>æ€»ä»»åŠ¡æ•°ï¼š</strong>${info.downloads.totalTasks}</p>
                </div>
                <div style="margin-top: 20px;">
                    <p><strong>æ›´æ–°æ—¶é—´ï¼š</strong>${new Date(info.timestamp).toLocaleString()}</p>
                </div>
            `;
            
            content.innerHTML = html;
        }

        // å·¥å…·å‡½æ•°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            if (bytes === -1) return 'æœªçŸ¥';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getStatusText(status) {
            const statusMap = {
                'PENDING': 'ç­‰å¾…ä¸­',
                'DOWNLOADING': 'ä¸‹è½½ä¸­',
                'COMPLETED': 'å·²å®Œæˆ',
                'FAILED': 'å¤±è´¥',
                'CANCELLED': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = message;
            document.querySelector('.container').insertBefore(div, document.querySelector('.tabs'));
            setTimeout(() => div.remove(), 5000);
        }

        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;
            document.querySelector('.container').insertBefore(div, document.querySelector('.tabs'));
            setTimeout(() => div.remove(), 5000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            checkConnection();
            refreshDownloadTasks();
            
            // å®šæœŸåˆ·æ–°
            setInterval(() => {
                checkConnection();
                refreshDownloadTasks();
            }, 10000);
        };
    </script>
</body>
</html> 